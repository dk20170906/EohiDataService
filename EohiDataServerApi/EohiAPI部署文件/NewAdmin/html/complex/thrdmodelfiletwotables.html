<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <!-- 避免IE使用兼容模式 -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
    <meta name="renderer" content="webkit">
    <!-- TopJUI框架样式 -->
    <link type="text/css" href="../../topjui/css/topjui.core.min.css" rel="stylesheet">
    <link type="text/css" href="../../topjui/themes/default/topjui.blue.css" rel="stylesheet" id="dynamicTheme" />
    <!-- FontAwesome字体图标 -->
    <link type="text/css" href="../../static/plugins/font-awesome/css/font-awesome.min.css" rel="stylesheet" />
    <!-- layui框架样式 -->
    <link type="text/css" href="../../static/plugins/layui/css/layui.css" rel="stylesheet" />
    <!-- jQuery相关引用 -->
    <script type="text/javascript" src="../../static/plugins/jquery/jquery.min.js"></script>
    <script type="text/javascript" src="../../static/plugins/jquery/jquery.cookie.js"></script>
    <!-- TopJUI框架配置 -->
    <script type="text/javascript" src="../../static/public/js/topjui.config.js"></script>
    <!-- TopJUI框架核心-->
    <script type="text/javascript" src="../../topjui/js/topjui.core.min.js"></script>
    <!-- TopJUI中文支持 -->
    <script type="text/javascript" src="../../topjui/js/locale/topjui.lang.zh_CN.js"></script>
    <!-- 上传组件 -->
    <link type="text/css" rel="stylesheet" href="../../static/plugins/webuploader/css/webuploader.css">
    <script type="text/javascript" src="../../static/plugins/webuploader/js/webuploader.min.js"></script>
    <!-- layui框架js -->
    <script type="text/javascript" src="../../static/plugins/layui/layui.js" charset="utf-8"></script>
</head>

<body>
    <!-- layout布局 开始 -->
    <div data-toggle="topjui-layout" data-options="fit:true">
        <div data-options="region:'center',title:'',fit:false,split:true,border:false,bodyCls:'border_right_bottom'"
             style="height:60%">
            <!-- datagrid表格 -->
            <table data-toggle="topjui-datagrid"
                   data-options="id:'userDg',
                        idField:'uuid',
                        treeField:'taskType',
                        pagination:true,
                        striped:true,
                        fitColumns:true,
                        rownumbers: true,
                 url: _ctx + '../Data/ThreeDUploadFiles/GetThreeDModels',
			            childTab: [{id:'southTabs'}]">
                <thead>
                    <tr>
                        <th data-options="field:'id',title:'ID',checkbox:true"></th>
                        <th data-options="field: 'modelName', title: '模型名称', sortable: true"></th>
                        <th data-options=" field: 'modeDescription', title: '模型说明(模型大小，文件数量，模型使用对像等)', sortable: true"></th>
                        <th data-options="field: 'modelImage', title: '缩略图', sortable: true, formatter: perviewImage"></th>
                        <th data-options=" field: 'modelForOutfit', title: '所属机构', sortable: true"></th>
                        <th data-options="field: 'modelVersion', title: '版本号', sortable: true"></th>
                        <th data-options=" field: 'modelRemark', title: '模型备注(对模型内的各别文件加以说明)', sortable: true "></th>
                        <th data-options=" field: 'createTime', title: '创建时间', sortable: true, formatter: dateConversion "></th>
                        <th data-options=" field: 'createUser', title: '创建人', sortable: true "></th>
                        <th data-options="field: 'editTime', title: '修改时间', sortable: true, formatter: dateConversion"></th>
                        <th data-options="field: 'editUser', title: '修改人', sortable: true"></th>
                        <th data-options="field: 'yujiPutTime', title: '预计发布时间', sortable: true, formatter: dateConversion"></th>
                        <th data-options=" field: 'modelIdentity', title: '模型标识唯一编码', sortable: true"></th>
                        <th data-options=" field: 'operate', title: '操作', sortable: true, formatter: operateFormatter, width: 100 "></th>
                    </tr>
                </thead>
            </table>
        </div>
        <div data-options="region:'south',fit:false,split:true,border:false"
             style="height:40%">
            <div data-toggle="topjui-tabs"
                 data-options="id:'southTabs',
             fit:true,
             border:false,
             parentGrid:{
                 type:'datagrid',
                 id:'userDg',
                 param:'modelIdentity:modelIdentity'
             }">
                <div title="模型文件" data-options="id:'tab0',iconCls:'fa fa-th'">
                    <!-- datagrid表格 -->
                    <table data-toggle="topjui-datagrid"
                           data-options="id:'southTab0',
                               initCreate: false,
                               fitColumns:true,
						    url: _ctx + '../Data/ThreeDUploadFiles/GetModelsBySelectIds?modelIdentity={modelIdentity}'">
                        <thead>
                            <tr>
                                <th data-options="field: 'id', title: '文件ID', checkbox: true"></th>
                                <th data-options="field: 'modelName', title: '模型名称' "></th>
                                <th data-options="field: 'fileName', title: '文件名称', sortable: true "></th>
                                <th data-options="field: 'fileSize', title: '文件大小', sortable: true "></th>
                                <th data-options=" field: 'fileSuffix', title: '文件后缀', sortable: true"></th>
                                <th data-options="field: 'uploadTime', title: '上传时间', sortable: true, formatter: dateConversion "></th>
                                <th data-options=" field: 'uploadUser', title: '上传人', sortable: true"></th>
                                <th data-options=" field: 'fileUrl', title: '文件路径', sortable: true, width: 150"></th>
                                <th data-options=" field: 'editTime', title: '修改时间', sortable: true, formatter: dateConversion "></th>
                                <th data-options="field: 'editUser', title: '修改人', sortable: true "></th>
                                <th data-options="field: 'modelId', title: '模型ID', sortable: true"></th>
                                <th data-options=" field: 'modelIdentity', title: '模型标识唯一编码', sortable: true"></th>
                                <th data-options=" field: 'operate', title: '操作', sortable: true, formatter: operateFormatterFiles, width: 100"></th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <!-- layout布局 结束 -->
    <!-- 表格工具栏开始 -->
    <div id="userDg-toolbar" class="topjui-toolbar"
         data-options="grid:{
           type:'datagrid',
           id:'userDg'
       }">
        <a href="javascript:void(0)"
           data-toggle="topjui-menubutton"
           data-options="method:'openDialog',
       extend: '#userDg-toolbar',
       iconCls: 'fa fa-plus',
       dialog:{
           id: 'userAddDialog',
                    title: '创建模型',
                    href: _ctx + '/html/complex/addmodels.html',
           buttonsGroup:[
               {text:'保存',url: _ctx + '../Data/ThreeDUploadFiles/AddModels',iconCls:'fa fa-plus',handler:'ajaxForm',btnCls:'topjui-btn-brown'}
           ]
       }">创建模型</a>
        <a href="javascript:void(0)"
           data-toggle="topjui-menubutton"
           data-options="method: 'openDialog',
            extend: '#userDg-toolbar',
            iconCls: 'fa fa-pencil',
            btnCls: 'topjui-btn-green',
            grid: {
                type: 'datagrid',
                id: 'userDg'
            },
            dialog: {
                width: 950,
                height: 500,
                             href: _ctx + '/html/complex/addmodels.html?uuid={id}',
                    url: _ctx + '../Data/ThreeDUploadFiles/GetModelById?uuid={id}',
                buttonsGroup: [
                    {
                        text: '更新',
                                  url: _ctx + '../Data/ThreeDUploadFiles/AddModels',
                        iconCls: 'fa fa-save',
                        handler: 'ajaxForm',
                        btnCls: 'topjui-btn-green'
                    }
                ]
            }">编辑模型</a>
        <!--<a href="javascript:void(0)"
           data-toggle="topjui-menubutton"
           data-options="method:'doAjax',
       extend: '#userDg-toolbar',
       btnCls:'topjui-btn-brown',
       iconCls:'fa fa-trash',
       url: _ctx + '../Data/ThreeDUploadFiles/DeleteByID',
       grid: {uncheckedMsg:'请先勾选要删除的数据', param: 'id:id'}">批量删除</a>-->

        <!--<button class="layui-btn layui-btn-xs" onclick="opentabforfilesbymodelids()" >test</button>-->



    </div>
    <!-- 表格工具栏结束 -->
</body>
</html>
<script type="text/javascript">
    function operateFormatter(value, row, index) {
       //  var htmlstr = '<button class="layui-btn layui-btn-xs" onclick="openEditDiag(\'' + row.id + '\')">编辑</button>';
        var   htmlstr = '<button class="layui-btn layui-btn-xs layui-btn-danger" onclick="deleteRow(\'' + row.id + '\')">删除</button>';
        return htmlstr;
    }

    function operateFormatterFiles(value, row, index) {
        var htmlstr = '<a class="layui-btn layui-btn-xs" href=" ' + _ctx + '../../' + row.fileUrl + '">下载</a>';
        htmlstr += '<button class="layui-btn layui-btn-xs layui-btn-danger" onclick="deleteRowFiles(\'' + row.id + '\')">删除</button>';
        return htmlstr;
    }


   


    function openEditDiag(uuid) {
        var ops = {
            id: 'editDialog',
            title: '编辑数据',
            width: 950,
            height: 500,
            closed: false,
            cache: false,
            href: _ctx + '/html/complex/addmodels.html?uuid=' + uuid,
            modal: true,
            buttons: [{
                text: '保存',
                iconCls: 'fa fa-save',
                btnCls: 'topjui-btn-blue',
                handler: function () {


                    // 提示信息
                    $.iMessager.alert('操作提示', '请根据具体情况编写代码，如ajax更新请求，请求失败提示，请求成功提示，请求成功后关闭窗口并刷新表格等！', 'messager-info');
                }
            }, {
                text: '关闭',
                iconCls: 'fa fa-close',
                btnCls: 'topjui-btn-red',
                handler: function () {
                    $editDialog.iDialog('close');
                }
            }],
            onLoad: function () {
                //加载表单数据
                $.getJSON(_ctx + '../Data/ThreeDUploadFiles/GetModelById?uuid=' + uuid, function (data) {
                    $editDialog.form('load', data);
                });
            }
        };
        $('#editDialog').iDialog('openDialog', ops);

        return;


        var $editDialog = $('#editDialog');
        $editDialog.iDialog({
            title: '编辑数据',
            width: 950,
            height: 500,
            closed: false,
            cache: false,
            href: _ctx + '/html/complex/addmodels.html?uuid=' + uuid,
            modal: true,
            buttons: [{
                text: '保存',
                iconCls: 'fa fa-save',
                btnCls: 'topjui-btn-blue',
                handler: function () {


                    // 提示信息
                    $.iMessager.alert('操作提示', '请根据具体情况编写代码，如ajax更新请求，请求失败提示，请求成功提示，请求成功后关闭窗口并刷新表格等！', 'messager-info');
                }
            }, {
                text: '关闭',
                iconCls: 'fa fa-close',
                btnCls: 'topjui-btn-red',
                handler: function () {
                    $editDialog.iDialog('close');
                }
            }],
            onLoad: function () {
                //加载表单数据
                $.getJSON(_ctx + '../Data/ThreeDUploadFiles/GetModelById?uuid=' + uuid, function (data) {
                    $editDialog.form('load', data);
                });
            }
        });
    }
      //删除模型
    function deleteRow(uuid) {
        var bm = confirm("确定要删除此文件吗？？？");
        if (bm) {
            $.ajax({
                type: 'get',
                url: _ctx + '../Data/ThreeDUploadFiles/DeleteByID',
                data: { id: uuid },
                success: function (data) {
                    if (data.statusCode == 200) {
                        $.iMessager.alert("提示信息", data.message);
                        $('#userDg').iDatagrid('reload');
                    } else {
                        $.iMessager.alert(data.message);
                    }
                },
                error: function (data) {

                }
            })
        }

        //$.iMessager.alert('操作提示', '请根据具体情况编写代码，如ajax删除请求，请求失败提示，请求成功提示，请求成功后刷新表格等！', 'messager-info');
    }
      //删除模型内部文件
    function deleteRowFiles(uuid) {
        var bm = confirm("确定要删除此文件吗？？？");
        if (bm) {
            $.ajax({
                type: 'get',
                url: _ctx + '../../Data/ThreeDUploadFiles/DeleteFileByID',
                data: { id: uuid },
                success: function (data) {
                    if (data.statusCode == 200) {
                        $.iMessager.alert("提示信息", data.message);
                        $('#southTab0').iDatagrid('reload');
                    } else {
                        $.iMessager.alert(data.message);
                    }
                },
                error: function (data) {
                    $.iMessager.alert(data.message);
                }
            })
        }

        // $.iMessager.alert('操作提示', '请根据具体情况编写代码，如ajax删除请求，请求失败提示，请求成功提示，请求成功后刷新表格等！', 'messager-info');
    }

    function showModelFiles() {
        var checkedRows = $('#productDg').iDatagrid('getChecked');
        var modelids = new Array();
        if (checkedRows.length > 0) {
            for (var i = 0; i < checkedRows.length; i++) {
                if (modelids.indexOf(checkedRows[i].id) > 0) {
                } else {
                    modelids.push(checkedRows[i].modelIdentity);
                }
            }
            $.ajax({
                type: 'get',
                url: _ctx + '../Data/ThreeDUploadFiles/SetModelIds?modelids=' + modelids,
                success: function (data) {
                    if (data.statusCode == 200) {
                        var opts = {
                            id: 'editwindow',
                            title: '编辑当前节点',
                            width: 950,
                            height: 500,
                            iconCls: 'fa fa-key',
                            href: _ctx + '/html/complex/thredmodelfilesdialog.html',
                            buttons: [{
                                text: '关闭',
                                iconCls: 'fa fa-close',
                                btnCls: 'topjui-btn-red',
                                handler: function () {
                                    $("#editwindow").iDialog('close');
                                }
                            }],
                        };

                        $('#editwindow').iDialog('openDialog', opts);
                    } else {
                        $.iMessager.alert('请先选择要操作的行!!', data.message);
                    }

                },
                error: function (data) {

                }
            })
        } else {
            $.iMessager.alert('请先选择要操作的行!!', "请求失败");
        }
    }


    //日期转换
    function dateConversion(value, row, index) {
        var data = value;
        if (data != null && data != "") {
            //取字符串中的数字
            var regexp = /[0-9]*/g;
            var time = data.match(regexp)
            //实现将时间戳转换为日期 （东8区）
            var date = new Date(parseInt(time[6]));
            Y = date.getFullYear() + '-';
            M = (date.getMonth() + 1 < 10 ? '0' + (date.getMonth() + 1) : date.getMonth() + 1) + '-';
            D = date.getDate() + ' ';
            h = date.getHours() + ':';
            m = date.getMinutes() + ':';
            s = date.getSeconds();
            return Y + M + D + h + m + s;
        }
        else {
            return "无";
        }
    }
    //缩略图
    function perviewImage(value, row, index) {
        if (row.modelImage != null) {
            htmlstr = '<img src="' + _ctx + "../" + row.modelImage + '" alt="" width="42" height="42">';
            return htmlstr;
        } else {
            var htmlstr = '<label class="layui-btn layui-btn-xs">未上传图片</label>';
            return htmlstr;
        }
    }


    function opentabforfilesbymodelids() {
        var checkedRowsm = $('#userDg').iDatagrid('getChecked');
        var modelids = new Array();
        if (checkedRowsm.length > 0) {  
            for (var i = 0; i < checkedRowsm.length; i++) {
                if (modelids.indexOf(checkedRowsm[i].id) > -1) {
                } else {
                        modelids.push(checkedRowsm[i].id);
                }
            }
            $.ajax({
                type: 'get',
                url: _ctx + '../Data/ThreeDUploadFiles/DeleteByID?id=' + modelids,
                success: function (data) {
                    if (data.statusCode == 200) {
                        $.iMessager.alert("提示信息", data.message);
                        $('#userDg').iDatagrid('reload');
                        //window.location.reload();
                    } else {
                        $.iMessager.alert(data.message);
                    }
                },
                error: function (data) {

                }
            })
        } else {
            $.iMessager.alert('请先选择要操作的行!!', "请求失败");
        }
    }

</script>